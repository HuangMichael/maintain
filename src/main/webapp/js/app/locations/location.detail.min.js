$(function () {
    $("#eqtables").bootgrid({
        formatters: {
            "report": function (column, row) {
                return "<a class='btn btn-default btn-xs'  onclick='report(" + row.id + ")' title='设备报修'><i class='glyphicon glyphicon-wrench'></i></a>"
            }
        }
    })
});
var reportId;
function report(id) {
    var status = "0";
    var path = "/equipment/findById/" + id;
    $.getJSON(path, function (data) {
        status = data["status"]
    });
    var curl = "/workOrderReportCart/loadReportedEqPage/" + id;
    if (status == "0") {
        $("#eqList").load(curl, function (data) {
            $("#show_eq_modal").modal("show");
            eqId = id
            reportId = id;
        })
    } else {
        equipReport(id)
    }
}
$("#equipReport").on("click", function () {
    $("#show_eq_modal").modal("hide");
    equipReport(eqId)
});
function equipReport(id) {
    var url = "/workOrderReportCart/add2Cart";
    $.post(url, {equipmentId: id}, function (data) {
        var size = $("#reportOrderSize").html();
        if (!size) {
            size = 0
        }
        $("#reportOrderSize").html(parseInt(size) + 1);
        showMessageBox("info", "已将设备报修加入到维修车!")
    })
}
$("#reportOrder").on("click", function () {
    var url = "/workOrderReportCart/findMyCart";
    $.getJSON(url, function (data) {
        var html = "";
        for (var x = 0; x < data.length; x++) {
            html += "<li>";
            html += "<a javascript:void(0)>";
            html += '<span class="label label-success">' + (x + 1) + "</span>";
            html += '<span class="body">';
            html += '<span class="message">' + data[x]["locations"]["description"] + "--" + data[x]["equipments"]["description"] + "</span>";
            html += '<span class="time">';
            html += "<span></span>";
            html += "</span>";
            html += "</span>";
            html += "</a>";
            html += " </li>"
        }
        $("#orderMsgCnt").html(data.length + "个报修信息");
        $("#orderBox").html(html)
    })
});
function generateReport() {
    var url = "/workOrderReport/save";
    $.post(url, function (data) {
        $("#main-content").load("/workOrderReport/list")
    })
}
function initLines() {
    $("#line_id").html("");
    var url = "/line/findByStatus";
    $.ajaxSettings.async = false;
    $.getJSON(url, function (data) {
        for (var x in data) {
            $("#line_id").append("<option value='" + data[x].id + "'>" + data[x].description + "</option>")
        }
    })
}
function addCons(woId, status) {
    if (status == "1") {
        $("#add_work_order_cons_modal .modal-body > form #woId").attr("value", woId);
        $("#add_work_order_cons_modal").modal("show")
    } else {
        alert("维修中工单才能添加耗材!");
        return
    }
}
function confirmSave() {
    var array = $("#addWorkOrderConsForm").serializeArray();
    var objStr = "{";
    for (var x in array) {
        if (array[x]["name"] && array[x]["value"]) {
            objStr += '"' + array[x]["name"] + '"';
            objStr += ":";
            objStr += '"' + array[x]["value"] + '",'
        }
    }
    objStr = objStr.substring(0, objStr.length - 1);
    objStr += "}";
    var consumptiveMaterial = JSON.parse(objStr);
    var url = "/workOrder/addCons";
    $.ajax({
        type: "POST", url: url, data: consumptiveMaterial, dataType: "JSON", success: function (msg) {
            $.bootstrapGrowl("设备配件信息添加成功", {type: "info", align: "right", stackup_spacing: 30})
        }, error: function (msg) {
            $.bootstrapGrowl("设备配件信息添加失败", {type: "danger", align: "right", stackup_spacing: 30})
        }
    })
}
$("#uploadForm").on("submit", function () {
    var fileName = $("#file").val();
    var pos = fileName.lastIndexOf("\\") + 1;
    $("#name").val(fileName.substr(pos, fileName.length));
    if (!fileName) {
        alert("请选中图片，再进行上传!");
        return false
    } else {
        return true
    }
});